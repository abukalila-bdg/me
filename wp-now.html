<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuaca & Jadwal Sholat — Berdasarkan Lokasi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  /* Target the div using its ID or class */
  #status {
    display: none;
  }
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-6">
  <div class="max-w-3xl w-full bg-white rounded-2xl shadow-lg p-6">
    <header class="mb-4">
      <h1 class="text-2xl font-semibold">Cuaca & Jadwal Sholat</h1>
      <p class="text-sm text-slate-500">Mengambil lokasi browser saat buka halaman — memanggil API cuaca & API jadwal sholat.</p>
    </header>

    <main class="space-y-6">
      <div id="status" class="text-sm text-slate-600">Menunggu izin lokasi...</div>

      <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-4 border rounded-lg">
          <h2 class="font-medium mb-2">Cuaca Sekarang</h2>
          <div id="weather" class="space-y-1 text-sm text-slate-700">
            <div id="weather-loading">-</div>
          </div>
        </div>

        <div class="p-4 border rounded-lg">
          <h2 class="font-medium mb-2">Jadwal Sholat Hari Ini</h2>
          <div id="prayer" class="space-y-1 text-sm text-slate-700">
            <div id="prayer-loading">-</div>
          </div>
        </div>
      </section>

      <footer class="text-xs text-slate-500">
        <p>Catatan: Data cuaca ambil dari <a class="underline" href="https://openweathermap.org/" target="_blank">OpenWeatherMap</a>. Jadwal sholat memakai API gratis dari <a class="underline" href="https://aladhan.com/" target="_blank">Aladhan</a>.</p>
      </footer>
    </main>
  </div>

  <script>
    // ----- PENGATURAN: Isi API key OpenWeatherMap di sini -----
    const OPENWEATHER_API_KEY = '65744da9ddf5f8e0df8b8f9aeac14c0a'; // <-- ganti

    // Pilihan method untuk Aladhan (1..12); 2 adalah ISNA (sering dipakai), sesuaikan bila perlu
    const ALADHAN_METHOD = 2;

    const statusEl = document.getElementById('status');
    const weatherEl = document.getElementById('weather');
    const prayerEl = document.getElementById('prayer');
    const weatherLoading = document.getElementById('weather-loading');
    const prayerLoading = document.getElementById('prayer-loading');

    // Helper: format waktu HH:MM
    function formatTime(t) {
      const d = new Date(t);
      const hh = d.getHours().toString().padStart(2,'0');
      const mm = d.getMinutes().toString().padStart(2,'0');
      return `${hh}:${mm}`;
    }

    // Ambil lokasi user (browser) dan panggil API
    function init() {
      if (!navigator.geolocation) {
        statusEl.textContent = 'Geolocation tidak tersedia di browser ini.';
        return;
      }

      statusEl.textContent = 'Meminta izin lokasi...';

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        statusEl.textContent = `Lokasi diterima: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;

        // Panggil keduanya bersamaan
        fetchWeather(lat, lon).catch(err => {
          weatherEl.innerHTML = `<div class="text-red-600">Gagal mengambil data cuaca: ${err.message}</div>`;
        });

        fetchPrayerTimes(lat, lon).catch(err => {
          prayerEl.innerHTML = `<div class="text-red-600">Gagal mengambil jadwal sholat: ${err.message}</div>`;
        });

      }, (err) => {
        statusEl.textContent = 'Izin lokasi ditolak atau gagal: ' + (err.message || err.code);
      }, { enableHighAccuracy: false, timeout: 10000 });
    }

    // Fetch: OpenWeatherMap Current Weather
    async function fetchWeather(lat, lon) {
      weatherLoading.textContent = 'Mengambil data cuaca...';

      if (!OPENWEATHER_API_KEY || OPENWEATHER_API_KEY === 'YOUR_OPENWEATHER_API_KEY') {
        weatherEl.innerHTML = `<div class="text-yellow-600">API key OpenWeather belum diisi. Masukkan OPENWEATHER_API_KEY.</div>`;
        return;
      }

      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=id&appid=${OPENWEATHER_API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`OpenWeather error: ${res.status}`);
      const data = await res.json();

      // Contoh fields: weather[0].description, main.temp, main.humidity, wind.speed
      const desc = data.weather?.[0]?.description || '-';
      const temp = data.main?.temp ?? '-';
      const feels = data.main?.feels_like ?? '-';
      const hum = data.main?.humidity ?? '-';
      const wind = data.wind?.speed ?? '-';
      const name = data.name || '';

      weatherEl.innerHTML = `
        <div class="text-lg font-semibold">${name ? name + ' — ' : ''}${temp}°C</div>
        <div class="text-sm text-slate-600">${desc} • terasa ${feels}°C</div>
        <div class="mt-2 text-sm space-y-0.5">
          <div>Kelembapan: ${hum}%</div>
          <div>Kecep. Angin: ${wind} m/s</div>
        </div>
      `;
    }

    // Fetch: Aladhan prayer times
    async function fetchPrayerTimes(lat, lon) {
      prayerLoading.textContent = 'Mengambil jadwal sholat...';

      // Aladhan endpoint: https://aladhan.com/prayer-times-api
      // Kita pakai endpoint timings dengan parameter latitude, longitude, method
      // Tidak perlu API key.
      const now = Math.floor(Date.now() / 1000);
      const url = `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=${ALADHAN_METHOD}`;

      const res = await fetch(url);
      if (!res.ok) throw new Error(`Aladhan error: ${res.status}`);
      const data = await res.json();

      if (data.code !== 200 && !data.data) throw new Error('Response Aladhan tidak valid');

      // data.data.timings adalah object dengan nama sholat -> waktu string (HH:MM)
      const timings = data.data?.timings || {};
      // Daftar sholat yang umum
      const order = ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];

      let html = '';
      order.forEach(k => {
        if (timings[k]) {
          html += `<div class="flex justify-between py-1 border-b last:border-b-0"><div>${k}</div><div class="font-medium">${timings[k]}</div></div>`;
        }
      });

      // tambahan: timezone info & date
      const dateReadable = data.data?.date?.readable || '';
      const meta = `<div class="text-xs text-slate-500 mt-2">Tanggal: ${dateReadable}</div>`;

      prayerEl.innerHTML = html + meta;
    }

    // jalankan saat muat
    window.addEventListener('load', init);
  </script>
</body>
</html>
